# Inform about processing 

I want each agent to print several things when it processes a user request:

- Print ">>>> Request received on {AGENT_NAME}" when it receives the "api key" data
- Print ">>>> Waiting a bit before sending the request to the {AGENT_NAME} - {AI_MODEL}" just before the 3 seconds wait
- Print ">>>> Sending request to {AGENT_NAME} - {AI_MODEL}" just before sending the request to the AI model
- Print "<<<< Response received from {AGENT_NAME} - {AI_MODEL}" (took {TIME_TAKEN}s)" when it receives the response from the AI_MODEL

Where {AGENT_NAME} is the name of the agent (GoogleAI, OpenAI, Anthropic), {AI_MODEL} is the model being used (e.g., gpt-4, gpt-3.5-turbo, claude-2, etc.),
and {TIME_TAKEN} is the time between sending the request to the AI model API and receiving the response.

I made the changes for Anthropic agent, OpenAI agent, but I need you to give me the content for the GoogleAI agent.
Tell me the full content of the files I need to change in order to implement this logging functionality.


# ANT Implement logging for GoogleAI agent to match OpenAI and Anthropic agents

I implement the logging functionality for the GoogleAI agent to match the existing implementation in OpenAI and Anthropic agents. The logging will display when requests are received, when they're being sent to the AI model, and when responses are received with timing information.

Based on the existing code in `anthropic-agent/src/main.ts` and `openai-agent/src/main.ts`, I can see that:

1. The "Request received" log is already implemented in `lib/src/lib/express-app.ts` and is triggered when the "api key" type is received
2. The waiting, sending, and response logs are implemented in `lib/src/lib/express-handlers.ts` in the `createPromptHandler` function
3. The GoogleAI agent needs to pass the agent name to `createPromptHandler` to enable proper logging

## Files to be modified:

1. `./code-ai-agent/googleai-agent/src/main.ts`

---

### File: `./code-ai-agent/googleai-agent/src/main.ts`

```typescript
import axios from 'axios';
import * as db from './db';
import { setDbStore, createApp, createPromptHandler, startServer } from '@code-ai-agent/lib';

const port = process.env.PORT ? Number(process.env.PORT) : 5000;

// Initialize the db instance for the shared library
setDbStore({
  connectToDatabase: db.connectToDatabase,
  getDb: db.getDb,
  run: db.run,
  get: db.get,
  all: db.all,
  initializeDatabase: db.initializeDatabase,
  resetDatabase: db.resetDatabase,
  removeDatabaseFile: db.removeDatabaseFile,
});

type DataEntry = { file_path: string; file_content: string };
type Content = { role: 'user' | 'model'; parts: Array<{ text: string }> };

// --- API Interaction ---
async function buildRequestBody(systemInstructions: string): Promise<any> {
  const prompt =
    (await db.get<{ value: string }>('SELECT value FROM config WHERE key = ?', ['prompt']))?.value || '';
  const dataEntries = await db.all<DataEntry>('SELECT file_path, file_content FROM data ORDER BY id ASC');

  const contents: Content[] = [];

  contents.push({
    role: 'user',
    parts: [{ text: 'I need your help on this project.' }],
  });

  for (const entry of dataEntries) {
    contents.push({
      role: 'model',
      parts: [{ text: `Please provide the content of the \`${entry.file_path}\` file.` }],
    });
    contents.push({
      role: 'user',
      parts: [
        {
          text: `Here is the content of the \`${entry.file_path}\` file:\n\`\`\`\n${entry.file_content}\n\`\`\`\n`,
        },
      ],
    });
  }

  if (!dataEntries.length && !prompt) {
    contents.push({
      role: 'model',
      parts: [{ text: 'How would you like to proceed with this project?' }],
    });
  }

  if (prompt) {
    contents.push({
      role: 'model',
      parts: [{ text: 'What would you like to do next?' }],
    });
    contents.push({
      role: 'user',
      parts: [{ text: prompt }],
    });
  }

  const requestBody: any = {
    contents,
    generationConfig: {
      temperature: 0.7,
      topP: 0.9,
      topK: 1,
    },
  };

  if (systemInstructions) {
    requestBody.system_instruction = {
      role: 'system',
      parts: [{ text: systemInstructions }],
    };
  }

  return requestBody;
}

function postToGoogleAI(requestBody: any, apiKey: string, model: string): Promise<any> {
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`;
  return axios.post(url, requestBody, {
    headers: {
      'Content-Type': 'application/json',
      'x-goog-api-key': apiKey,
    },
  });
}

function createErrorResponse(errorMessage: string): any {
  return {
    candidates: [
      {
        content: {
          parts: [
            {
              text: errorMessage
            }
          ],
          role: 'model'
        },
      }
    ],
    usageMetadata: {
      promptTokenCount: 0,
      candidatesTokenCount: 0,
      totalTokenCount: 0
    }
  };
}

async function processPrompt(apiKey: string, model: string, instructions: string): Promise<any> {
  try {
    const requestBody = await buildRequestBody(instructions);
    const apiResponse = await postToGoogleAI(requestBody, apiKey, model);
    return apiResponse.data;
  } catch (error) {
    let errorMessage = 'An unknown error occurred while processing your request.';

    if (axios.isAxiosError(error)) {
      if (error.response) {
        errorMessage = `API Error (${error.response.status}): ${JSON.stringify(error.response.data)}`;
      } else if (error.request) {
        errorMessage = 'Network error: No response received from the API.';
      } else {
        errorMessage = `Request error: ${error.message}`;
      }
    } else if (error instanceof Error) {
      errorMessage = `Error: ${error.message}`;
    }

    console.error('Google AI API error:', errorMessage);
    return createErrorResponse(errorMessage);
  }
}

const handlePrompt = createPromptHandler(processPrompt, 'Google AI');
const app = createApp(handlePrompt, 'Google AI');

startServer(app, port, db.removeDatabaseFile);
```

---

## Summary of changes:

The only change needed is in `googleai-agent/src/main.ts`:

- **Line 113**: Changed `createPromptHandler(processPrompt)` to `createPromptHandler(processPrompt, 'Google AI')` to pass the agent name as the second parameter
- **Line 114**: Changed `createApp(handlePrompt, 'Google AI')` to ensure the agent name is consistently used (this was already correct in your original code)

This change enables the logging functionality that is already implemented in the shared library (`lib/src/lib/express-handlers.ts` and `lib/src/lib/express-app.ts`) to work properly for the Google AI agent, matching the behavior of the OpenAI and Anthropic agents.

Anthropic claude-sonnet-4-5-20250929 (13k in, 1k out)


