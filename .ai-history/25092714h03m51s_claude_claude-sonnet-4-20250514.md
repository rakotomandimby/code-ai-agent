# Improve `./code-ai-agent/googleai-agent/src/main.ts` to create and insert data in SQLite database

I want to enhance the existing Express server in `./code-ai-agent/googleai-agent/src/main.ts`.
I want that when the server receives a POST request on the `/` path and the body has a "type" field with value "api key",
then the server creates a new SQLite database (if it does not exist), 
create a "config" table with 3 columns (id, key, value),
then insert the recors ("api_key", <value of "text" field in the request body>) in that table,

Tell me the "npm install" command to issue and the full new content of the files I need to modify in order to have that.



# ANT Enhance Google AI Agent to create SQLite database and store API key configuration data

I need to modify the Google AI Agent's main.ts file to handle SQLite database operations when receiving POST requests with API key data. The enhancement will create a SQLite database, set up a config table, and store API key information when the request body contains a "type" field with value "api key".

## NPM Install Command

First, you need to install the SQLite dependency:

```bash
npm install sqlite3 --save
npm install --save-dev @types/sqlite3
```

## Files to Modify

### File: `./code-ai-agent/googleai-agent/src/main.ts`

```typescript
import express from 'express';
import sqlite3 from 'sqlite3';
import path from 'path';
import fs from 'fs';

const host = process.env.HOST ?? 'localhost';
const port = process.env.PORT ? Number(process.env.PORT) : 5000;

const app = express();

// Middleware to parse JSON bodies
app.use(express.json());

// Database path
const dbPath = path.join(__dirname, 'config.db');

// Initialize database
function initializeDatabase(): Promise<sqlite3.Database> {
  return new Promise((resolve, reject) => {
    const db = new sqlite3.Database(dbPath, (err) => {
      if (err) {
        reject(err);
        return;
      }
      
      // Create config table if it doesn't exist
      db.run(`CREATE TABLE IF NOT EXISTS config (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        key TEXT NOT NULL UNIQUE,
        value TEXT NOT NULL
      )`, (err) => {
        if (err) {
          reject(err);
          return;
        }
        resolve(db);
      });
    });
  });
}

app.post('/', async (req, res) => {
  try {
    const { type, text } = req.body;
    
    if (type === 'api key') {
      if (!text) {
        return res.status(400).json({ 
          error: 'Missing text field for API key' 
        });
      }
      
      const db = await initializeDatabase();
      
      // Insert or update the API key
      db.run(`INSERT OR REPLACE INTO config (key, value) VALUES (?, ?)`, 
        ['api_key', text], 
        function(err) {
          if (err) {
            console.error('Database error:', err);
            return res.status(500).json({ 
              error: 'Failed to store API key' 
            });
          }
          
          console.log(`API key stored with row ID: ${this.lastID}`);
          res.json({ 
            message: 'API key stored successfully',
            rowId: this.lastID 
          });
        }
      );
      
      db.close();
    } else {
      res.json({ message: 'GoogleAI Agent is running' });
      console.log('Received a POST request at /');
    }
  } catch (error) {
    console.error('Error processing request:', error);
    res.status(500).json({ 
      error: 'Internal server error' 
    });
  }
});

app.listen(port, host, () => {
  console.log(`[ ready ] http://${host}:${port}`);
});
```

## Implementation Details

I implement this enhancement by:

1. **Adding SQLite3 dependency** - The sqlite3 package provides the necessary SQLite database functionality for Node.js applications.

2. **Adding JSON middleware** - Express needs `express.json()` middleware to parse JSON request bodies.

3. **Database initialization function** - I create an `initializeDatabase()` function that creates the SQLite database file and the config table with the specified schema (id, key, value columns).

4. **Request body validation** - I check for the "type" field with value "api key" and ensure the "text" field is present.

5. **Database operations** - I use `INSERT OR REPLACE` to handle both new insertions and updates of existing API keys, storing the key as "api_key" and the value from the request body's "text" field.

6. **Error handling** - I implement proper error handling for database operations and invalid requests.

7. **Database cleanup** - I close the database connection after each operation to prevent resource leaks.

The database file will be created in the same directory as the compiled main.js file, and the server will respond with success messages including the database row ID when API keys are stored successfully.

Anthropic claude-sonnet-4-20250514 (3k in, 1k out)


