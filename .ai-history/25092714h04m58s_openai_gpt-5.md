# Improve `./code-ai-agent/googleai-agent/src/main.ts` to create and insert data in SQLite database

I want to enhance the existing Express server in `./code-ai-agent/googleai-agent/src/main.ts`.
I want that when the server receives a POST request on the `/` path and the body has a "type" field with value "api key",
then the server creates a new SQLite database (if it does not exist), 
create a "config" table with 3 columns (id, key, value),
then insert the recors ("api_key", <value of "text" field in the request body>) in that table,

Tell me the "npm install" command to issue and the full new content of the files I need to modify in order to have that.



# OPN Enhance googleai-agent Express server to store API key in a SQLite database on POST /

I implement the feature so that when the server receives a POST request to `/` with a JSON body where type is "api key" and text holds the key value, it will create (if needed) a SQLite database, create a config table with columns (id, key, value), and insert/update the row ("api_key", <text>). The server still responds with the default message for other requests. I also add JSON parsing middleware and safe file/directory handling.

Command to install required dependencies:
- cd code-ai-agent && npm install sqlite3 @types/sqlite3

Files modified:
- ./code-ai-agent/googleai-agent/src/main.ts

Below is the full content of the modified file, followed by explanations.

File: ./code-ai-agent/googleai-agent/src/main.ts
```
import express from 'express';
import path from 'node:path';
import fs from 'node:fs';
import sqlite3 from 'sqlite3';

sqlite3.verbose();

const host = process.env.HOST ?? 'localhost';
const port = process.env.PORT ? Number(process.env.PORT) : 5000;

const app = express();

// Enable JSON body parsing
app.use(express.json());

// Location of the SQLite database file (created on demand)
const DATA_DIR = path.join(process.cwd(), 'data');
const DB_PATH = path.join(DATA_DIR, 'googleai-agent.sqlite');

// Ensure the data directory exists
function ensureDataDir() {
  if (!fs.existsSync(DATA_DIR)) {
    fs.mkdirSync(DATA_DIR, { recursive: true });
  }
}

function openDb(): Promise<sqlite3.Database> {
  ensureDataDir();
  return new Promise((resolve, reject) => {
    const db = new sqlite3.Database(DB_PATH, (err) => {
      if (err) {
        reject(err);
      } else {
        resolve(db);
      }
    });
  });
}

function run(db: sqlite3.Database, sql: string, params: unknown[] = []): Promise<void> {
  return new Promise((resolve, reject) => {
    db.run(sql, params, function (err) {
      if (err) return reject(err);
      resolve();
    });
  });
}

async function initializeSchema(db: sqlite3.Database): Promise<void> {
  // Create the `config` table if it does not exist.
  // Columns: id (PK), "key" (unique), value
  const createTableSql = `
    CREATE TABLE IF NOT EXISTS config (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      "key" TEXT NOT NULL UNIQUE,
      value TEXT
    )
  `;
  await run(db, createTableSql);
}

async function upsertConfigKey(db: sqlite3.Database, key: string, value: string): Promise<void> {
  // Insert or update the config row for the given key
  const upsertSql = `
    INSERT INTO config ("key", value)
    VALUES (?, ?)
    ON CONFLICT("key") DO UPDATE SET value=excluded.value
  `;
  await run(db, upsertSql, [key, value]);
}

app.post('/', async (req, res) => {
  // For any POST, keep the original default message unless we handle "api key"
  try {
    const { type, text } = req.body ?? {};

    if (type === 'api key') {
      if (typeof text !== 'string' || text.trim() === '') {
        res.status(400).json({ error: 'Invalid or missing "text" field. It must be a non-empty string.' });
        return;
      }

      const apiKeyValue = text.trim();

      const db = await openDb();
      try {
        await initializeSchema(db);
        await upsertConfigKey(db, 'api_key', apiKeyValue);
      } finally {
        db.close();
      }

      console.log('Stored API key into SQLite database at:', DB_PATH);
      res.json({ message: 'API key stored successfully.' });
      return;
    }

    // Default response if not processing an API key
    res.json({ message: 'GoogleAI Agent is running' });
    console.log('Received a POST request at /');
  } catch (error: any) {
    console.error('Error handling POST /:', error);
    res.status(500).json({ error: 'Internal Server Error' });
  }
});

app.listen(port, host, () => {
  console.log(`[ ready ] http://${host}:${port}`);
});
```

Explanation:
- I add express.json() middleware to parse JSON request bodies.
- I use sqlite3 to manage a SQLite database file placed in ./data/googleai-agent.sqlite at runtime. The directory is created if missing.
- On POST /:
  - If body.type equals "api key", and body.text is a non-empty string, I create the config table if needed and upsert the row so that the key "api_key" is stored with the provided value. The "key" column is quoted to comply with your exact schema name.
  - Otherwise, I return the default message to preserve previous behavior.
- I ensure the database connection is closed after the operation and return informative errors for bad input.

Install dependencies:
- cd code-ai-agent && npm install sqlite3 @types/sqlite3

OpenAI gpt-5 (3k in, 2k out)


