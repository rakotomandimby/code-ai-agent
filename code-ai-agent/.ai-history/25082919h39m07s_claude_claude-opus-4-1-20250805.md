# Write de technical description of the application.

I want to produce a technical description of the application that I will give to LLM.
The LLM will then help me to implement new features and resolve bugs.
But providing a technical description will help the LLM to better understand the application, 
thus improving the quality of the responses.

Provide me that technical description of the application.


# ANT Technical Description of Code AI Agent Monorepo Application

This document provides a comprehensive technical description of the Code AI Agent Monorepo, a Node.js application built with Nx that implements a multi-provider AI agent system supporting OpenAI, Google AI, and Anthropic APIs.

## Architecture Overview

The application follows a monorepo architecture using Nx build system with the following structure:

### Projects Structure
- **lib** - Shared library containing core functionality
- **openai-agent** - OpenAI API agent service (port 4000)
- **googleai-agent** - Google AI API agent service (port 5000)  
- **anthropic-agent** - Anthropic API agent service (port 6000)

### Core Design Pattern
The application implements a **Template Method Pattern** where:
1. Common functionality is abstracted in the `lib` package
2. Each agent extends base classes with provider-specific implementations
3. A factory-based router creation system enables consistent API endpoints across all agents

## Shared Library (`lib`)

### Core Classes

#### 1. **AIHttpClient** (Base HTTP Client)
- Abstract base class for making HTTP requests to AI providers
- Handles authentication headers, API endpoints, and error responses
- Supports "disabled" model mode for testing
- Implements provider-specific error handling with dedicated error response generators
- Manages debug URLs for request inspection via Pipedream

#### 2. **BaseRepository** (SQLite Database Layer)
- Manages persistent storage using SQLite databases in `/tmp/`
- Stores conversation history, system instructions, and model parameters
- Tables: `messages`, `system_instruction`, `model_to_use`, `temperature`, `top_p`
- Provides CRUD operations with Promise-based async interface

#### 3. **Chunk** (Data Transfer Object)
- Represents atomic data units with types: `message`, `system_instruction`, `model_to_use`, `temperature`, `top_p`
- Handles SQL escaping for safe database storage
- Maintains unique IDs for ordering and retrieval

#### 4. **MultiTurnChat** (Conversation Manager)
- Manages multi-turn conversation history
- Provides unique append functionality to avoid duplicates
- Returns structured conversation data for API requests

#### 5. **createAgentRouter** (Express Router Factory)
- Factory function creating standardized Express routers for each agent
- Endpoints:
  - `GET /{agent}/clear` - Clears conversation history
  - `POST /{agent}` - Handles incoming messages and triggers AI responses
- Implements 1-second delay before processing to allow message aggregation
- Measures and logs response times for performance monitoring

### Error Response Generators
- **getOpenAIErrorResponse** - Formats errors in OpenAI response structure
- **getGoogleAIErrorResponse** - Formats errors in Google AI response structure  
- **getAnthropicErrorResponse** - Formats errors in Anthropic response structure
- **getDisabledModelResponse** - Returns mock responses when model is "disabled"

## Agent Services

Each agent service follows the same architectural pattern:

### Common Structure
```
{agent}-agent/
├── src/
│   ├── main.ts                 # Express server initialization
│   ├── routes.ts               # Router configuration
│   ├── ai-http-client.ts      # Provider-specific HTTP client
│   ├── repository/             # Database repository
│   └── model/                  # Request body builder
```

### OpenAI Agent

#### OpenAIBody Class
- Builds OpenAI-compatible request payloads
- Special handling for o1/o3/o4 models (no temperature/top_p parameters)
- Hypothetical GPT-5 model support
- Converts "model" role to "assistant" for compatibility
- System instructions in message body for o1-series models

#### OpenAIAIHttpClient
- Extends AIHttpClient with OpenAI configuration
- API endpoint: `https://api.openai.com/v1/chat/completions`
- Uses Bearer token authentication

### Google AI Agent

#### GoogleAIBody Class  
- Constructs Google AI-specific request format
- Includes safety settings (all categories set to BLOCK_NONE)
- Supports generation configuration (temperature, topP)
- System instructions as separate field

#### GoogleAIAIHttpClient
- Dynamic URL construction based on model selection
- API endpoint pattern: `https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent`
- Uses x-goog-api-key header for authentication

### Anthropic Agent

#### AnthropicBody Class
- Builds Anthropic Messages API payloads
- Fixed max_tokens at 32000
- System instructions as separate "system" field
- Role conversion from "model" to "assistant"

#### AnthropicAIHttpClient
- API endpoint: `https://api.anthropic.com/v1/messages`
- Uses x-api-key header and anthropic-version header (2023-06-01)

## Request Flow

1. **Message Reception**: Client sends POST request to `/{agent}` endpoint
2. **Data Storage**: System stores configuration and messages in SQLite
3. **Delayed Processing**: 1-second timer allows message batching
4. **Body Construction**: Agent-specific body builder creates API payload
5. **API Request**: HTTP client sends request to provider API
6. **Response Handling**: Success responses or formatted error responses returned
7. **Cleanup**: Database cleared after response

## Configuration

### Environment Variables
- `OPENAI_API_KEY` - OpenAI API authentication
- `GOOGLEAI_API_KEY` - Google AI API authentication  
- `ANTHROPIC_API_KEY` - Anthropic API authentication
- `PORT` - Override default ports for each service

### Build Configuration
- TypeScript compilation with CommonJS output
- Nx build system with project dependencies
- ESBuild for production builds
- Jest for testing framework

## Database Schema

All agents use identical SQLite schema:

```sql
CREATE TABLE messages (
    id INTEGER,
    role TEXT,
    content TEXT
)

CREATE TABLE system_instruction (
    id INTEGER,
    content TEXT  
)

CREATE TABLE model_to_use (
    id INTEGER,
    content TEXT
)

CREATE TABLE temperature (
    id INTEGER,
    content TEXT
)

CREATE TABLE top_p (
    id INTEGER,
    content TEXT
)
```

## Key Features

1. **Provider Abstraction**: Unified interface across different AI providers
2. **Conversation Persistence**: SQLite-based conversation history
3. **Error Resilience**: Provider-specific error formatting maintains API compatibility
4. **Debug Support**: Pipedream URLs for request inspection
5. **Performance Monitoring**: Response time logging for all requests
6. **Model Flexibility**: Support for various models including disabled mode for testing
7. **Async Operations**: Promise-based database and HTTP operations

## Development Workflow

The monorepo uses Nx commands:
- `npx nx run-many --target=build` - Build all projects
- `npx nx run-many --target=serve` - Start all services
- `npx nx reset` - Clear Nx cache

The application is designed for extensibility, allowing easy addition of new AI providers by implementing the base classes and following the established patterns.

Anthropic claude-opus-4-1-20250805 (16k in, 1k out)


